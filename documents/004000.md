# Nginx 入门

## 一. Nginx 介绍

### 1. Nginx 解决的问题

为什么要学习 Nginx

- 问题 1：客户端到底要将请求发送给哪台服务器
- 问题 2：如果所有客户端的请求都发送给了服务器 1, 那么貌似服务器 2 的集群就没什么用
- 问题 3：客户端发送的请求可能是申请动态资源的，也有申请静态资源的

<p align="center"><img src=https://linmingdao.github.io/blog/assets/tech/004000_00.jpg></p>

为了解决上面的问题, 我们可以使用 Nginx 来处理

在搭建集群后，使用 Nginx 做反向代理

<p align="center"><img src=https://linmingdao.github.io/blog/assets/tech/004000_01.jpg></p>

### 2. Nginx 的特点

- 稳定性极强，7\*24 小时不间断运行(就是一直运行)
- Nginx 提供了非常丰富的配置实例 3.占用内存小，并发能力强(随便配置一下就是 5w+,而 tomcat 的默认线程池是 150)

## 二. Nginx 的安装

### 1. 安装

该部分内容省略

### 2. Nginx 的配置文件

```bash
cd /etc/nginx/
cat nginx.conf
```

nginx.conf 文件内容如下:

```bash
user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;
# 以上统称为全局块
# worker_processes的数值越大，Nginx的并发能力就越强
# error_log代表Nginx错误日志存放的位置
# pid是Nginx运行的一个标识

events {
    worker_connections  1024;
}
# events块
# worker_connections的数值越大，Nginx的并发能力就越强

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
}

# http块
# include代表引入一个外部文件
# include /etc/nginx/mime.types;	mime.types中存放着大量媒体类型
# include /etc/nginx/conf.d/*.conf;	引入了conf.d下以.conf为结尾的配置文件
```

conf.d 目录下只有一个 default.conf 文件，内容如下:

```bash
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    #charset koi8-r;
    #access_log  /var/log/nginx/host.access.log  main;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }
	# location块
	# root:将接受到的请求根据/usr/share/nginx/html去查找静态资源
	# index:默认去上述的路径中找到index.html或index.htm

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }


    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ {
    #    root           html;
    #    fastcgi_pass   127.0.0.1:9000;
    #    fastcgi_index  index.php;
    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
    #    include        fastcgi_params;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny  all;
    #}
}

# server块
# listen代表Nginx监听的端口号
# server_name代表Nginx接受请求的IP
```

## 三. Nginx 实现反向代理

### 1. 正向代理和反向代理介绍

正向代理(VPN)：

- 正向代理服务是由客户端设立的
- 客户端了解代理服务器和目标服务器都是谁
- 帮助咱们实现突破访问权限，提高访问的速度，对目标服务器隐藏客户端的 ip 地址

<p align="center"><img src=https://linmingdao.github.io/blog/assets/tech/004000_02.jpg></p>

反向代理：

- 反向代理服务器是配置在服务端的
- 客户端不知道访问的到底是哪一台服务器
- 达到负载均衡，并且可以隐藏服务器真正的 ip 地址

<p align="center"><img src=https://linmingdao.github.io/blog/assets/tech/004000_03.jpg></p>

### 2. 基于 Nginx 实现反向代理

准一台目标服务器: http://ncthz.top:8080/

```bash
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    location / {
        proxy_pass http://ncthz.top:8080/;
    }
}
```

这时我们访问 80 端口可以看到 8080 端口 tomcat 的默认首页

### 3. 关于 Nginx 的 location 路径映射

优先级关系：

```bash
(location = ) >
(location /xxx/yyy/zzz) >
(location ^~) >
(location ~,~*) >
(location /起始路径) >
(location /)
```

```bash
#1. = 匹配
location = / {
	#精准匹配，主机名后面不能带能和字符串
	#例如www.baidu.com不能是www.baidu.com/id=xxx
}
```

```bash
#2. 通用匹配
location /xxx {
	#匹配所有以/xxx开头的路径
	#例如127.0.0.1:8080/xxx	xxx可以为空，为空则和=匹配一样
}
```

```bash
#3. 正则匹配
location ~ /xxx {
	#匹配所有以/xxx开头的路径
}
```

```bash
#4. 匹配开头路径
location ^~ /xxx/xx {
	#匹配所有以/xxx/xx开头的路径
}
```

```bash
#5. 匹配结尾路径
location ~* \.(gif/jpg/png)$ {
	#匹配以.gif、.jpg或者.png结尾的路径
}
```

```bash
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    #一个server块里面可以配置多个location
	location = /index {
        proxy_pass http://192.168.199.109:8081/; #tomcat首页
    }

	location ^~ /ssm/ {
        proxy_pass http://192.168.199.109:8081/ssm/; #毕设前台首页
    }

    location / {
        proxy_pass http://192.168.199.109:8080/; #Hello Nginx
    }
}
```

## 四. Nginx 负载均衡

Nginx 为我们默认提供了三种负载均衡的策略：

### 1. 轮询：

将客户端发起的请求，平均分配给每一台服务器

想实现 Nginx 轮询负载均衡机制只需要修改配置文件如下:

```bash
upstream my_server{
    server ncthz.top:8080;
    server ncthz.top:8081;
}
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

	location / {
        proxy_pass http://my_server/;	#tomcat首页
    }
}
```

```bash
upstream 名字{
    server ip:端口;
    server 域名:端口;
}
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

	location / {
        proxy_pass http://upstream的名字/;
    }
}
```

### 2. 权重：

会将客户端的请求，根据服务器的权重值不同，分配不同的数量

实现权重的方式：在配置文件中 upstream 块中加上 weight

```bash
upstream my_server{
    server ncthz.top:8080 weight=10;
    server ncthz.top:8081 weight=2;
}
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

	location / {
        proxy_pass http://my_server/;	#tomcat首页
    }
}
```

### 3. ip_hash:

基于发起请求的客户端的 ip 地址不同，他始终会将请求发送到指定的服务器上,就是说如果这个客户端的请求的 ip 地址不变，那么处理请求的服务器将一直是同一个

实现 ip_hash 方式：在配置文件 upstream 块中加上 ip_hash:

```bash
upstream my_server{
	ip_hash;
    server ncthz.top:8080 weight=10;
    server ncthz.top:8081 weight=2;
}
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

	location / {
        proxy_pass http://my_server/;	#tomcat首页
    }
}
```

## 五. Nginx 动静分离

Nginx 的并发能力公式：

```
worker_processes * worker_connections / 4|2 = Nginx最终的并发能力

动态资源需要/4，静态资源需要/2

Nginx通过动静分离来提升Nginx的并发能力，更快的给用户响应
```

### 1. 动态资源代理

### 2. 动态资源代理

### 3. 动态资源代理

## 六. Nginx 集群
